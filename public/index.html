<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Global Code Board</title>
	<style>
		body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
		textarea { width: 100%; height: 60vh; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 14px; padding: 12px; box-sizing: border-box; }
		button { padding: 10px 16px; font-size: 14px; cursor: pointer; }
		#row { display: flex; gap: 8px; align-items: center; margin-top: 12px; }
		#status { min-height: 1.2em; color: #555; }
		.snapshot-item { background: #f8f9fa; padding: 8px; margin: 4px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
		.snapshot-link { color: #007bff; text-decoration: none; }
		.snapshot-link:hover { text-decoration: underline; }
	</style>
</head>
<body>
    <div id="userModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
        <div style="background:white; padding:20px; border-radius:8px; width:300px; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">
            <h2>Enter your name</h2>
            <input type="text" id="username" style="width:100%; padding:8px; margin:10px 0;" placeholder="Your name...">
            <button onclick="joinChat()" style="width:100%;">Join</button>
        </div>
    </div>

    <h1>Global Code Board</h1>
    <p>Everyone sees and edits the same code in real time. <a href="/" style="color: #007bff; text-decoration: none;">ðŸ”„ Live Editor</a></p>
    <textarea id="code" placeholder="Start typing..."></textarea>
    <div id="row">
		<input type="text" id="snapshotName" placeholder="Enter snapshot name..." style="flex: 1; padding: 10px 16px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; margin-right: 8px;" />
		<button id="saveBtn">Save Snapshot</button>
		<span id="status" aria-live="polite"></span>
	</div>
	<div id="snapshotRow" style="margin-top:8px; display:none;">
		<label>Snapshot link:</label>
		<input id="snapshotLink" readonly style="width:100%; padding:8px;" />
	</div>
	<div id="sharedSnapshots" style="margin-top:16px;">
		<h3>Shared Snapshots</h3>
		<div id="snapshotList"></div>
	</div>

	<script src="/socket.io/socket.io.js"></script>
	<script>
		const socket = io();
		const textarea = document.getElementById('code');
		const status = document.getElementById('status');
		const snapshotList = document.getElementById('snapshotList');
		const userModal = document.getElementById('userModal');
		let username = '';

		// Show username modal on load
		userModal.style.display = 'block';

		function joinChat() {
			const nameInput = document.getElementById('username');
			username = nameInput.value.trim();
			if (!username) {
				alert('Please enter a name');
				return;
			}
			userModal.style.display = 'none';
			socket.emit('user:join', username);
		}

		// Handle enter key in username input
		document.getElementById('username').addEventListener('keypress', (e) => {
			if (e.key === 'Enter') joinChat();
		});

		socket.on('connect', () => {
			status.textContent = 'Connected';
		});

		socket.on('user:joined', ({ username }) => {
			status.textContent = `${username} joined`;
			setTimeout(() => {
				if (status.textContent === `${username} joined`) {
					status.textContent = 'Connected';
				}
			}, 3000);
		});

		socket.on('user:left', ({ username }) => {
			status.textContent = `${username} left`;
			setTimeout(() => {
				if (status.textContent === `${username} left`) {
					status.textContent = 'Connected';
				}
			}, 3000);
		});

		// Receive initial content
		socket.on('init', ({ code }) => {
			isApplyingRemote = true;
			textarea.value = code || '';
			lastLocalValue = textarea.value;
			isApplyingRemote = false;
		});

		// Receive initial snapshots
		socket.on('snapshots:init', ({ snapshots }) => {
			snapshots.forEach(snapshot => {
				sharedSnapshots.set(snapshot.id, { url: snapshot.url, name: snapshot.name });
			});
			updateSnapshotList();
			if (snapshots.length > 0) {
				status.textContent = `Loaded ${snapshots.length} existing snapshot(s)`;
			}
		});

		// Receive broadcast updates from others
		socket.on('code:broadcast', ({ code, username }) => {
			isApplyingRemote = true;
			textarea.value = code || '';
			lastLocalValue = textarea.value;
			isApplyingRemote = false;
			status.textContent = `Updated by ${username}`;
		});

		// Receive snapshot creation broadcast
		socket.on('snapshot:created', ({ id, name, url }) => {
			sharedSnapshots.set(id, { url: url, name: name });
			updateSnapshotList();
			status.textContent = 'New snapshot shared!';
		});

		// Receive snapshot deletion broadcast
		socket.on('snapshot:deleted', ({ id }) => {
			sharedSnapshots.delete(id);
			updateSnapshotList();
			status.textContent = 'Snapshot deleted';
		});

		function updateSnapshotList() {
			if (sharedSnapshots.size === 0) {
				snapshotList.innerHTML = '<p style="color:#666;">No snapshots yet</p>';
				return;
			}
			
			snapshotList.innerHTML = '';
			sharedSnapshots.forEach((snapshot, id) => {
				const item = document.createElement('div');
				item.className = 'snapshot-item';
				item.innerHTML = `
					<a href="${snapshot.url}" target="_blank" class="snapshot-link">${snapshot.name}</a>
					<button onclick="deleteSnapshot('${id}')" style="background:#dc3545; color:white; border:none; padding:4px 8px; font-size:12px;">Delete</button>
				`;
				snapshotList.appendChild(item);
			});
		}

		window.deleteSnapshot = async (id) => {
			if (!confirm('Delete this snapshot? This cannot be undone.')) return;
			try {
				const res = await fetch('/api/snapshot/' + encodeURIComponent(id), { method: 'DELETE' });
				if (!res.ok) throw new Error('Failed to delete');
				status.textContent = 'Deleted!';
			} catch (e) {
				status.textContent = 'Delete failed';
			}
		};

		// Send local changes
		textarea.addEventListener('input', () => {
			if (isApplyingRemote) return;
			const value = textarea.value;
			if (value === lastLocalValue) return;
			lastLocalValue = value;
			socket.emit('code:update', { code: value });
			status.textContent = 'Synced';
		});

		// Clear placeholder when text is pasted or typed
		textarea.addEventListener('paste', () => {
			// Clear placeholder after a short delay to allow paste to complete
			setTimeout(() => {
				if (textarea.value && textarea.value !== '') {
					textarea.placeholder = '';
				}
			}, 10);
		});

		// Clear placeholder on first input
		textarea.addEventListener('input', () => {
			if (textarea.value && textarea.value !== '') {
				textarea.placeholder = '';
			}
		}, { once: true });

		document.getElementById('saveBtn').addEventListener('click', async () => {
			const nameInput = document.getElementById('snapshotName');
			const name = nameInput.value.trim() || `Snapshot ${Date.now()}`;
			
			status.textContent = 'Saving snapshot...';
			try {
				const res = await fetch('/api/snapshot', { 
					method: 'POST', 
					headers: { 
						'Accept': 'application/json',
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ name: name, username: username })
				});
				let data;
				const ct = res.headers.get('content-type') || '';
				if (ct.includes('application/json')) {
					data = await res.json();
				} else {
					const text = await res.text();
					throw new Error('Unexpected response: ' + text.slice(0, 120));
				}
				if (!res.ok) throw new Error(data.error || 'Failed to save');
				document.getElementById('snapshotRow').style.display = 'block';
				const link = document.getElementById('snapshotLink');
				link.value = data.url;
				link.focus();
				link.select();
				status.textContent = 'Snapshot saved!';
				
				// Clear the textarea and name input after saving
				textarea.value = '';
				lastLocalValue = '';
				textarea.placeholder = 'Start typing...';
				nameInput.value = '';
				socket.emit('code:update', { code: '' });
			} catch (e) {
				status.textContent = e.message || 'Error saving snapshot';
			}
		});

		// Initialize snapshot list
		updateSnapshotList();
	</script>
</body>
</html>


